<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Post to Azure Logic Apps</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
      body {
        font-family: Arial, sans-serif;
        padding-right: 2%;
        padding-left: 2%;
        padding-top: 4%;
        padding-bottom: 2%;
        background-image: url(https://i.postimg.cc/Kj6BgdQg/Background.jpg);
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-position: center;
        background-size: cover;
      }

      h1 {
        padding-top: 3%;
        font-size: 42px;
        text-align: center;
      }

      h2 {
        padding-right: 3%;
        padding-left: 3%;
        font-size: 36px;
        margin-top: 30px;
      }

      #ShowDateTime {
        font-size: 36px;
        font-weight: bold;
      }

      input[type="text"],
      input[type="password"] {
        margin-left: 3%;
        width: 50%;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 30px;
      }

      span {
        font-size: 32px;
      }

      button {
        width: 40%;
        padding: 10px;
        margin-left: 3%;
        margin-top: 10px;
        margin-bottom: 2%;
        font-size: 32px;
        cursor: pointer;
      }

      .message {
        font-size: 30px;
        margin-left: 3%;
        margin-top: 10px;
        display: none;
      }

      .messageGps {
        font-size: 30px;
        margin-left: 3%;
        margin-top: 10px;
        display: none;
      }

      .messageWifi {
        font-size: 30px;
        margin-left: 3%;
        margin-top: 10px;
        display: none;
      }
    }

    /* â†‘ æ³¨æ„ï¼šåŸå§‹ç¢¼åœ¨æ­¤å¤šäº†ä¸€å€‹é¡å¤–çš„ '}'ï¼Œæˆ‘ä¿ç•™åŸç‹€ï¼Œè‹¥è¦ä¿®æ­£å¯åˆªé™¤æ­¤è¡Œä¸Šæ–¹çš„ '}'ã€‚ */

    @media only screen and (min-width: 760px) {
      body {
        font-family: Arial, sans-serif;
        padding-right: 2%;
        padding-left: 2%;
        padding-top: 2%;
        padding-bottom: 2%;
      }

      h1 { font-size: 44px; }
      h2 { font-size: 38px; }

      #ShowDateTime {
        font-size: 38px;
        font-weight: bold;
      }

      input[type="text"],
      input[type="password"] {
        width: 50%;
        padding: 12px 20px;
        margin: 8px 0;
        box-sizing: border-box;
        font-size: 32px;
      }

      span { font-size: 34px; }
      button { width: 45%; font-size: 34px; }
    }

    @media only screen and (min-width: 1024px) {
      body {
        font-family: Arial, sans-serif;
        padding-right: 20%;
        padding-left: 20%;
        padding-top: 2%;
        padding-bottom: 7%;
      }

      h1 { font-size: 48px; }
      h2 { font-size: 36px; }

      input[type="text"],
      input[type="password"] {
        width: 30%;
        font-size: 32px;
      }

      span { font-size: 30px; }
      button { width: 30%; font-size: 30px; }
    }
    </style>
  </head>

  <body>
    <div
      style="
        background: linear-gradient(10deg, rgba(255, 169, 0, 0.4) 35%, rgba(117, 207, 0, 0.4) 60%);
        box-shadow: 1px 2px 22px 0 rgba(89, 87, 87, 0.85);
        padding-bottom: 15%;
        width: 100%;
        height: 100%;
        border-radius: 10px;
      "
    >
      <h1>DGå‚™æ´æ‰“å¡ç³»çµ±27</h1>

      <h2><span id="ShowDateTime"></span></h2>

      <h2>è«‹å¡«å¯«æ‚¨çš„EmailåŠæ‰“å¡å¯†ç¢¼</h2>
      <input type="text" id="emailInput" placeholder="Email" />
      <span>@dragon-geosciences.com</span>
      <br />

      <input type="password" id="passwordInput" placeholder="æ‰“å¡å¯†ç¢¼" />
      <span>
        <a
          href="https://apps.powerapps.com/play/e/bb11f212-1ae2-eb5d-8ce4-f378003e9486/a/cc0698c0-b4e6-4328-ab41-864959c42446?tenantId=4475b104-50f2-419f-a8fc-ac004dcde2c1&ScreenChoice=Password"
          target="_blank"
          >ã€Šå¿˜è¨˜å¯†ç¢¼æˆ–å»ºç«‹å¯†ç¢¼ã€‹</a
        >
      </span>
      <br />

      <button id="showPasswordButton" onclick="togglePasswordVisibility()">
        ğŸ”“é¡¯ç¤ºå¯†ç¢¼
      </button>

      <br />
      <h2>GPS+Wifi æ‰“å¡</h2>
      <button id="startButton">ä¸Šç­</button>
      <button id="endButton">ä¸‹ç­</button>
      <br />
      <span id="message" class="message"></span>

      <h2>GPS æ‰“å¡(Manager Informed)</h2>
      <button id="startButtonGps">ä¸Šç­</button>
      <button id="endButtonGps">ä¸‹ç­</button>
      <br />
      <span id="messageGps" class="messageGps"></span>

      <h2>Wifi æ‰“å¡(Manager Informed, Desktop Available)</h2>
      <button id="startButtonWifi">ä¸Šç­</button>
      <button id="endButtonWifi">ä¸‹ç­</button>
      <br />
      <span id="messageWifi" class="messageWifi"></span>

      <h2>ç›®å‰è¨Šè™Ÿç‹€æ…‹</h2>
      <h2>
        Wifi: <span id="getWifi">è¼‰å…¥ä¸­...</span> / GPS:
        <span id="location">è¼‰å…¥ä¸­...</span>
      </h2>
    </div>

    <script>
      function togglePasswordVisibility() {
        var input = document.getElementById("passwordInput");
        var btn = document.getElementById("showPasswordButton");
        if (input.type === "password") {
          input.type = "text";
          btn.textContent = "ğŸ”’éš±è—å¯†ç¢¼";
        } else {
          input.type = "password";
          btn.textContent = "ğŸ”“é¡¯ç¤ºå¯†ç¢¼";
        }
      }

      function showDateTime() {
        var now = new Date();
        var y = now.getFullYear();
        var m = now.getMonth() + 1;
        var d = now.getDate();
        var hh = now.getHours();
        var mm = now.getMinutes();
        if (hh < 10) hh = "0" + hh;
        if (mm < 10) mm = "0" + mm;
        var ts = y + "/" + m + "/" + d + " " + hh + ":" + mm;
        document.getElementById("ShowDateTime").innerHTML = ts;
      }

      // â–¼ é€™è£¡æ˜¯å¯¦éš›ç™¼é€åˆ° Azure Logic Appsï¼ˆAutomateï¼‰çš„ AJAX POST
      function sendPostRequest(payload) {
        $.ajax({
          url:
            "https://bb11f2121ae2eb5d8ce4f378003e94.86.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2e969194d6c6468dac1d213313b09a90/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8YeBjd08q50rdE_7JPS-E3dr3S_0s7kc3MNMJXPH9gg",
          method: "POST",
          data: JSON.stringify(payload),
          contentType: "application/json",
          success: function (res) {
            console.log("POST Request successful");
            console.log(res);
          },
          error: function (err) {
            console.log("Error occurred during POST Request");
            console.log(err);
          },
        });
      }

      function getLocationAndSendData(ksitype, /* unused */ locationObj, method) {
        var email = $("#emailInput").val() + "@dragon-geosciences.com";
        var password = $("#passwordInput").val();

        var d = new Date();
        var date = d.getFullYear() + "/" + (d.getMonth() + 1) + "/" + d.getDate();

        var t = new Date();
        var hh = t.getHours();
        var mm = t.getMinutes();
        if (hh < 10) hh = "0" + hh;
        if (mm < 10) mm = "0" + mm;
        var time = hh + ":" + mm;

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function (pos) {
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            var alt = pos.coords.altitude;

            // ä¸‰å€‹åœ°é»åˆ°ç›®å‰ä½ç½®çš„è·é›¢ï¼ˆå…¬é‡Œï¼‰
            var d1 = calculateDistance(lat, lng, 22.6269627, 120.3101946);
            var d2 = calculateDistance(lat, lng, 22.6084169, 120.2735785);
            var d3 = calculateDistance(lat, lng, 22.6087448, 120.2734469);
            var minDistance = Math.min(d1, d2, d3);

            $.getJSON("https://api64.ipify.org?format=json", function (ipRes) {
              var ipAddr = ipRes.ip;

              getTaipeiTime()
                .then(function (taipeiTime) {
                  // â–¼ é€™å€‹ç‰©ä»¶å°±æ˜¯é€åˆ° Logic Apps çš„ JSON æœ¬æ–‡
                  var payload = {
                    email: email,
                    ksitype: ksitype,
                    date: date,
                    time: time,
                    altitude: alt,
                    latitude: lat,
                    longitude: lng,
                    ipAddress: ipAddr,
                    taipeiTime: taipeiTime,
                    method: method,
                    password: password,
                    device: getDeviceType(),
                    minDistance: minDistance,
                  };

                  sendPostRequest(payload);
                })
                .catch(function (e) {
                  console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e);
                });
            });
          });
        } else {
          console.log("Geolocation is not supported by this browser.");
        }
      }

      function getDeviceType() {
        var s = navigator.userAgent.toLowerCase();
        return /iphone|ipod|ipad|android|blackberry|opera mini|iemobile|mobile/i.test(s)
          ? "Mobile"
          : "Desktop";
      }

      function getTaipeiTime() {
        return fetch("https://worldtimeapi.org/api/timezone/Asia/Taipei")
          .then(function (r) { return r.json(); })
          .then(function (j) { return j.datetime.slice(11, 16); })
          .catch(function (e) { console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e); });
      }

      setInterval(showDateTime, 1000);

      var startButtonClicked = false;
      $("#startButton").click(function () {
        if (!startButtonClicked) {
          getLocationAndSendData("1", null, "WifiGps");
          startButtonClicked = true;
          $(this).text("å·²é€å‡º").prop("disabled", true);
          $("#message").text(" - " + new Date().toLocaleString()).show();
        }
      });

      $("#endButton").click(function () {
        getLocationAndSendData("2", null, "WifiGps");
        $("#message").text(" - " + new Date().toLocaleString()).show();
        $(this).prop("disabled", true);
        setTimeout(function () {
          $("#endButton").text("ä¸‹ç­").prop("disabled", false);
        }, 15000);
      });

      var startButtonGpsClicked = false;
      $("#startButtonGps").click(function () {
        if (!startButtonGpsClicked) {
          getLocationAndSendData("1", null, "OnlyGps");
          startButtonGpsClicked = true;
          $(this).text("å·²é€å‡º").prop("disabled", true);
          $("#messageGps").text(" - " + new Date().toLocaleString()).show();
        }
      });

      $("#endButtonGps").click(function () {
        getLocationAndSendData("2", null, "OnlyGps");
        $("#messageGps").text(" - " + new Date().toLocaleString()).show();
        $(this).prop("disabled", true);
        setTimeout(function () {
          $("#endButtonGps").text("ä¸‹ç­").prop("disabled", false);
        }, 15000);
      });

      var startButtonWifiClicked = false;
      $("#startButtonWifi").click(function () {
        if (!startButtonWifiClicked) {
          getLocationAndSendData("1", null, "OnlyWifi");
          startButtonWifiClicked = true;
          $(this).text("å·²é€å‡º").prop("disabled", true);
          $("#messageWifi").text(" - " + new Date().toLocaleString()).show();
        }
      });

      $("#endButtonWifi").click(function () {
        getLocationAndSendData("2", null, "OnlyWifi");
        $("#messageWifi").text(" - " + new Date().toLocaleString()).show();
        $(this).prop("disabled", true);
        setTimeout(function () {
          $("#endButtonWifi").text("ä¸‹ç­").prop("disabled", false);
        }, 15000);
      });

      function calculateDistance(lat1, lon1, lat2, lon2) {
        var dLat = deg2rad(lat2 - lat1);
        var dLon = deg2rad(lon2 - lon1);
        var a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) *
            Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) * Math.sin(dLon / 2);
        var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return c * 6371; // å…¬é‡Œ
      }

      function deg2rad(deg) {
        return deg * (Math.PI / 180);
      }

      function getIP() {
        fetch("https://api64.ipify.org?format=json")
          .then(function (r) { return r.json(); })
          .then(function (j) {
            var ip = j.ip;
            var allow = {
              "61.216.53.19": true,
              "61.216.53.23": true,
              "60.249.202.14": true,
              "60.249.202.178": true,
              "61.216.53.20": true,
              "61.216.53.21": true,
              "61.216.53.22": true,
              "61.216.53.24": true,
              "60.249.202.15": true,
              "60.249.202.179": true,
              "60.249.202.180": true,
              "60.249.202.13": true,
              "61.219.152.91": true,
              "60.249.132.61": true,
            };
            document.getElementById("getWifi").textContent = allow[ip]
              ? "æ­£å¸¸"
              : "æœªé€£ç·š";
          })
          .catch(function (e) { console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š" + e); });
      }

      function getMinDistance() {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (pos) {
              var lat = pos.coords.latitude;
              var lng = pos.coords.longitude;
              var d1 = calculateDistance(lat, lng, 22.6269627, 120.3101946);
              var d2 = calculateDistance(lat, lng, 22.6084169, 120.2735785);
              var d3 = calculateDistance(lat, lng, 22.6087448, 120.2734469);
              var minD = Math.min(d1, d2, d3);
              document.getElementById("location").textContent =
                minD < 0.3 ? "æ­£å¸¸" : "å°šæœªåˆ°é”";
            },
            function (err) {
              document.getElementById("location").textContent = "ç„¡æ³•ç²å–ä½ç½®è³‡è¨Š";
              console.log("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
            }
          );
        } else {
          document.getElementById("location").textContent = "ä¸æ”¯æ´åœ°ç†ä½ç½®å®šä½";
        }
      }

      window.addEventListener("load", getIP);
      window.addEventListener("load", getMinDistance);
    </script>
  </body>
</html>
