<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clock-In-Out (Backup System)</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 2% 2% 6%;
      background-image: url(https://i.postimg.cc/Kj6BgdQg/Background.jpg);
      background-repeat: no-repeat;
      background-attachment: fixed;
      background-position: center;
      background-size: cover;
    }
    h1 { font-size: 44px; text-align: center; margin-top: 12px; }
    h2 { font-size: 32px; margin: 18px 0 8px; }
    h3 { margin: 12px 0; }
    #ShowDateTime { font-size: 20px; font-weight: bold; }
    input[type="text"], input[type="password"] {
      width: 60%; max-width: 520px; padding: 10px; font-size: 22px; margin: 6px 8px 10px 0;
    }
    button {
      min-width: 160px; padding: 10px; font-size: 22px; margin: 8px 12px 12px 0; cursor: pointer;
      border-radius: 10px; border: 1px solid #aaa; background: #fff;
    }
    .panel {
      background: linear-gradient(12deg, rgba(255,169,0,.35) 35%, rgba(117,207,0,.35) 60%);
      box-shadow: 1px 2px 22px rgba(89,87,87,.85);
      border-radius: 12px; padding: 24px 18px;
    }
    .tag { font-size: 18px; color: #555; }
    .status { font-size: 18px; }
    .ok { color:#0a7d1f; } .bad{ color:#c2452d; }
    .toast {
      position: fixed; left: 50%; bottom: 24px; transform: translateX(-50%);
      background: rgba(0,0,0,.75); color:#fff; padding:10px 16px; border-radius:8px;
      font-size:16px; display:none;
    }
    @media (min-width: 1024px) {
      input[type="text"], input[type="password"] { width: 40%; }
      button { min-width: 200px; }
    }
  </style>
</head>
<body>
  <div class="panel">
    <h2 style="text-align:center;">Clock-In-Out 5</h2>
    <h3 style="text-align:center;">(For Emergency Use Only)</h3>
    <h3>Nowï¼š<span id="ShowDateTime"></span></h3>

    <h3>Enter your Username & Password</h3>
    <div>
      <input type="text" id="emailInput" placeholder="username only, before ã€Œ@ã€" />
      <span class="tag">@dragon-geosciences.com</span>
    </div>
    <div>
      <input type="password" id="passwordInput" placeholder="æ‰“å¡å¯†ç¢¼" />
      <button id="togglePwd">ğŸ”“ é¡¯ç¤ºå¯†ç¢¼</button>
      <a class="tag" href="https://apps.powerapps.com/play/e/bb11f212-1ae2-eb5d-8ce4-f378003e9486/a/cc0698c0-b4e6-4328-ab41-864959c42446?tenantId=4475b104-50f2-419f-a8fc-ac004dcde2c1&ScreenChoice=Password" target="_blank">ã€Šå¿˜è¨˜æˆ–å»ºç«‹å¯†ç¢¼ã€‹</a>
    </div>

    <h3>Use this backup interface only if the main system is down. Please keep a screenshot of the issue for record. Records will be forwarded to HR for verification.</h3>
    <button data-mode="Backup" data-type="1">Clock In</button>
    <button data-mode="Backup" data-type="2">Clock Out</button>

    <h2>ç›®å‰è¨Šè™Ÿç‹€æ…‹</h2>
    <div class="status">Wi-Fiï¼š<span id="wifiStatus">åµæ¸¬ä¸­â€¦</span>ã€€GPSï¼š<span id="gpsStatus">åµæ¸¬ä¸­â€¦</span></div>
  </div>

  <div id="toast" class="toast"></div>

<script>
/* === 1) Flow ç«¯é»ï¼ˆä¾ä½ è¦æ±‚ä¸æ”¹ï¼‰ === */
const FLOW_URL = "https://bb11f2121ae2eb5d8ce4f378003e94.86.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/2e969194d6c6468dac1d213313b09a90/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8YeBjd08q50rdE_7JPS-E3dr3S_0s7kc3MNMJXPH9gg";

/* === 2) UI === */
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=> t.style.display='none', 2400);
}
document.getElementById('togglePwd').onclick = () => {
  const ipt = document.getElementById('passwordInput');
  const btn = document.getElementById('togglePwd');
  if (ipt.type === 'password') { ipt.type='text'; btn.textContent='ğŸ”’ éš±è—å¯†ç¢¼'; }
  else { ipt.type='password'; btn.textContent='ğŸ”“ é¡¯ç¤ºå¯†ç¢¼'; }
};
function tickClock() {
  const d = new Date();
  const z = n => (n<10?'0':'')+n;
  document.getElementById('ShowDateTime').textContent =
    `${d.getFullYear()}/${d.getMonth()+1}/${d.getDate()} ${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
}
setInterval(tickClock, 1000); tickClock();

/* === 3) å·¥å…· === */
function getDeviceType() {
  const s = navigator.userAgent.toLowerCase();
  return /iphone|ipod|ipad|android|blackberry|opera mini|iemobile|mobile/i.test(s) ? "Mobile" : "Desktop";
}
function calculateDistance(lat1, lon1, lat2, lon2) {
  const toRad = d => d * Math.PI / 180;
  const dLat = toRad(lat2 - lat1), dLon = toRad(lon2 - lon1);
  const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
  return 6371 * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)); // å…¬é‡Œ
}
function getTaipeiTimeISO() {
  return fetch("https://worldtimeapi.org/api/timezone/Asia/Taipei", { cache: "no-store" })
    .then(r => r.json())
    .then(j => j.datetime).catch(()=>null);
}
function getPublicIP() {
  return fetch("https://api64.ipify.org?format=json", { cache: "no-store" })
    .then(r => r.json()).then(j => j.ip).catch(()=> null);
}

/* === 4) é€è³‡æ–™ï¼ˆsendBeacon é¿é–‹ CORSï¼‰ === */
function sendToFlow(payload) {
  const blob = new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" });
  let ok = false;
  try { ok = navigator.sendBeacon(FLOW_URL, blob); } catch(e) { ok = false; }
  if (!ok) {
    fetch(FLOW_URL, { method: "POST", body: blob, mode: "no-cors" }).catch(() => {});
  }
}

/* === 5) Wi-Fi / GPS ç‹€æ…‹ï¼ˆè‡ªå‹•åˆ·æ–°ï¼‰ === */
function detectWifi() {
  getPublicIP().then(ip => {
    const allow = {
      "61.216.53.19":1,"61.216.53.23":1,"60.249.202.14":1,"60.249.202.178":1,"61.216.53.20":1,
      "61.216.53.21":1,"61.216.53.22":1,"61.216.53.24":1,"60.249.202.15":1,"60.249.202.179":1,
      "60.249.202.180":1,"60.249.202.13":1,"61.219.152.91":1,"60.249.132.61":1
    };
    const el = document.getElementById('wifiStatus');
    el.textContent = allow[ip] ? "æ­£å¸¸" : "æœªé€£ç·š";
    el.className  = allow[ip] ? "ok" : "bad";
  });
}
function detectGPS() {
  const el = document.getElementById('gpsStatus');
  if (!navigator.geolocation) { el.textContent="ä¸æ”¯æ´åœ°ç†å®šä½"; el.className="bad"; return; }
  navigator.geolocation.getCurrentPosition(pos => {
    const { latitude, longitude } = pos.coords;
    const d1 = calculateDistance(latitude, longitude, 22.6269627, 120.3101946);
    const d2 = calculateDistance(latitude, longitude, 22.6084169, 120.2735785);
    const d3 = calculateDistance(latitude, longitude, 22.6087448, 120.2734469);
    const minD = Math.min(d1,d2,d3);
    el.textContent = minD < 0.1 ? "æ­£å¸¸" : "å°šæœªåˆ°é”";
    el.className  = minD < 0.1 ? "ok" : "bad";
  }, _ => {
    el.textContent = "ç„¡æ³•ç²å¾—ä½ç½®";
    el.className = "bad";
  }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }); // æœ€æ–°ä½ç½®
}
function refreshSignals(){ detectWifi(); detectGPS(); }
window.addEventListener("load", refreshSignals);
setInterval(refreshSignals, 30000);
document.addEventListener("visibilitychange", ()=> { if(!document.hidden) refreshSignals(); });
window.addEventListener("online",  refreshSignals);
window.addEventListener("offline", refreshSignals);

/* === 6) ä¸»æµç¨‹ï¼šçµ„ payload â†’ é–€æª»ï¼ˆORï¼‰â†’ sendBeacon === */
function nowDate() {
  const d=new Date();
  const z=n=>(n<10?'0':'')+n;
  return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
}
function nowTime() {
  const d=new Date();
  const z=n=>(n<10?'0':'')+n;
  return `${z(d.getHours())}:${z(d.getMinutes())}:${z(d.getSeconds())}`;
}
async function submitPunch(ksitype, methodTag) {
  const emailUser = $("#emailInput").val().trim();
  const password = $("#passwordInput").val().trim();
  if (!emailUser) { toast("è«‹å…ˆè¼¸å…¥å¸³è™Ÿ"); return; }
  if (!password) { toast("è«‹å…ˆè¼¸å…¥æ‰“å¡å¯†ç¢¼"); return; }

  // æŠ“æœ€æ–° IP / å°åŒ—æ™‚é–“
  const [ip, taipeiISO] = await Promise.all([getPublicIP(), getTaipeiTimeISO()]);

  // æŠ“æœ€æ–° GPS èˆ‡è·é›¢
  let lat=null, lng=null, alt=null, minDistance=999;
  await new Promise(resolve => {
    if (!navigator.geolocation) return resolve();
    navigator.geolocation.getCurrentPosition(p => {
      lat = p.coords.latitude; lng = p.coords.longitude; alt = p.coords.altitude ?? null;
      const d1 = calculateDistance(lat, lng, 22.6269627, 120.3101946);
      const d2 = calculateDistance(lat, lng, 22.6084169, 120.2735785);
      const d3 = calculateDistance(lat, lng, 22.6087448, 120.2734469);
      minDistance = Math.min(d1,d2,d3);
      resolve();
    }, _ => resolve(), { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
  });

  // â˜… é–€æª»ï¼šè·é›¢å…§ OR ç™½åå–® IP å…¶ä¸€æˆç«‹å³å¯ï¼›åä¹‹æ‰æ“‹
  const allow = {
    "61.216.53.19":1,"61.216.53.23":1,"60.249.202.14":1,"60.249.202.178":1,"61.216.53.20":1,
    "61.216.53.21":1,"61.216.53.22":1,"61.216.53.24":1,"60.249.202.15":1,"60.249.202.179":1,
    "60.249.202.180":1,"60.249.202.13":1,"61.219.152.91":1,"60.249.132.61":1
  };
  const ipAllowed  = !!allow[ip];
  const nearOffice = Number.isFinite(minDistance) && minDistance < 0.1;
  if (!(nearOffice || ipAllowed)) {
    toast("ä½ç½®/ç¶²è·¯ä¸ç¬¦è¦ç¯„ï¼šè«‹åˆ°è¾¦å…¬å®¤æˆ–é€£å…¬å¸ Wi-Fi å†æ‰“å¡");
    return;
  }

  const payload = {
    email: `${emailUser}@dragon-geosciences.com`,
    ksitype: ksitype,                    // "1" ä¸Šç­ / "2" ä¸‹ç­
    date: nowDate(),                     // "YYYY-MM-DD"
    time: nowTime(),                     // "HH:mm:ss"
    altitude: alt,                       // number | null
    latitude: lat,                       // number | null
    longitude: lng,                      // number | null
    ipAddress: ip,                       // string | null
    taipeiTime: taipeiISO,               // string | null
    method: methodTag + "_" + getDeviceType(),
    password: password,
    device: getDeviceType(),
    minDistance: Number.isFinite(minDistance) ? minDistance : 999
  };

  sendToFlow(payload);
  toast("å·²é€å‡ºï¼ˆç€è¦½å™¨ä¸å›æ‡‰å…§å®¹ï¼Œè«‹åˆ° Flow åŸ·è¡Œç´€éŒ„ç¢ºèªï¼‰");
}

/* === 7) ç¶å®šæŒ‰éˆ• === */
document.querySelectorAll("button[data-mode]").forEach(btn => {
  btn.addEventListener("click", e => {
    const mode = e.currentTarget.getAttribute("data-mode");
    const type = e.currentTarget.getAttribute("data-type"); // "1" or "2"
    submitPunch(type, mode);
  });
});
</script>
</body>
</html>



